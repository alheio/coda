PROJECT(coda)
CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

SET(CMAKE_C_FLAGS "-O3 -Wall -fomit-frame-pointer -funroll-loops -Wno-long-long -Wno-variadic-macros -fPIC")
SET(CMAKE_CXX_FLAGS "${CMAKE_C_FLAGS}")

IF(CMAKE_SYSTEM_NAME STREQUAL Linux)
ADD_DEFINITIONS(-DARCH_LINUX)
ELSE(CMAKE_SYSTEM_NAME STREQUAL Linux)
ADD_DEFINITIONS(-DARCH_FREEBSD)
ENDIF(CMAKE_SYSTEM_NAME STREQUAL Linux)

FIND_PATH(INCLUDE_EXPAT expat.h)
INCLUDE_DIRECTORIES(${INCLUDE_EXPAT})
FIND_LIBRARY(LIB_EXPAT expat)

INCLUDE_DIRECTORIES(.)

SET (LIBDIR lib)
IF (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "x86_64")
SET (LIBDIR lib64)
ENDIF (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "x86_64")

ADD_LIBRARY(MAFSA STATIC MAFSA/automaton_basic.c)
INSTALL(TARGETS MAFSA DESTINATION ${LIBDIR})
INSTALL(DIRECTORY MAFSA/ DESTINATION include/MAFSA FILES_MATCHING PATTERN "*.h")
INSTALL(DIRECTORY MAFSA/ DESTINATION include/MAFSA FILES_MATCHING PATTERN "*.hpp")
INSTALL(DIRECTORY MAFSA/ DESTINATION include/MAFSA FILES_MATCHING PATTERN "*.tcc")

ADD_LIBRARY(uac STATIC uac/sla.c uac/uac.cpp uac/uac-base.c)
ADD_LIBRARY(uacbase STATIC uac/sla.c uac/uac-base.c)

ADD_EXECUTABLE(uac_compiler uac/uac_compiler.cpp)
TARGET_LINK_LIBRARIES(uac_compiler uac coda ${LIB_EXPAT})
ADD_CUSTOM_COMMAND(TARGET uac_compiler POST_BUILD COMMAND ./uac_compiler ${coda_SOURCE_DIR}/uac/uac.xml uac.automaton)

ADD_EXECUTABLE(uac_detect uac/uac_detect.cpp)
TARGET_LINK_LIBRARIES(uac_detect uac coda MAFSA ${LIB_EXPAT})

ADD_EXECUTABLE(test_tjson tests/tjson/main.cpp)

INSTALL(FILES uac/uac.h DESTINATION include/uac)
INSTALL(TARGETS uac DESTINATION ${LIBDIR})
INSTALL(TARGETS uacbase DESTINATION ${LIBDIR})
INSTALL(FILES uac/uac.xml ${coda_BINARY_DIR}/uac.automaton DESTINATION share/uac)
INSTALL(TARGETS uac_detect uac_compiler DESTINATION bin)

AUX_SOURCE_DIRECTORY(coda/ SRC_coda)
ADD_LIBRARY(coda ${SRC_coda})
TARGET_LINK_LIBRARIES(coda ${LIB_expat} pthread)
INSTALL(TARGETS coda DESTINATION ${LIBDIR})
INSTALL(DIRECTORY coda/ DESTINATION include/coda FILES_MATCHING PATTERN "*.h")
INSTALL(DIRECTORY coda/ DESTINATION include/coda FILES_MATCHING PATTERN "*.hpp")
INSTALL(DIRECTORY coda/ DESTINATION include/coda FILES_MATCHING PATTERN "*.tcc")
SET_TARGET_PROPERTIES(coda PROPERTIES VERSION 0.1 SOVERSION 1)

